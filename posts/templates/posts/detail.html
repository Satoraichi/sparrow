{% extends "posts/base.html" %}
{% load static %}

{% block title %}"{{ post.content|linebreaksbr}}" by {{ current_user.display_name }} | Sparrow{% endblock %}

{% block extra_style %}
<link rel="preload" href="{% static 'posts/detail.css' %}" as="style">
<link rel="stylesheet" href="{% static 'posts/detail.css' %}">
{% endblock %}

{% block content %}

<div id="quoteModal">
    <div class="modal-content">
        <textarea id="quoteText" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã™ã‚‹..."></textarea>
        <input type="hidden" id="quotePostId">
        <div id="quotedOriginal" style="padding:.6rem; border-left:3px solid #8885; margin-bottom:1rem;"></div>
        <div style="display:flex; justify-content:space-between; gap:.6rem; margin-top:.8rem;">
            <button id="closeModal" class="basic" style="background-color:#ff492d;">é–‰ã˜ã‚‹</button>
            <button id="sendQuote" class="basic">ãƒã‚¹ãƒˆ</button>
        </div>
    </div>
</div>

<div class="login_status">
    <div class="status">
        <div class="icon_background">
            {% if current_user.icon %}
                <img src="{{ current_user.icon.url }}" class="icon">
            {% endif %}
        </div>
        {% if current_user.is_authenticated %}
        <div class="user">
            <div class="name"><label>{{ current_user.display_name }}</label> @{{ current_user.username }}</div>
        {% endif %}
        </div>
    </div>
    {% if current_user.is_authenticated %}
    <form action="{% url 'accounts:logout' %}" method="post" class="logout-form">
        {% csrf_token %}
        <button type="submit" class="logout-button">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </form>
    {% endif %}
</div>

<div class="posts-wrapper">
    <h2 style="color: #fff; margin-bottom: 1rem;">ãƒã‚¹ãƒˆè©³ç´°</h2>

    <div class="unit"> 
        <div class="post">
            <div class="icon_background">
                <img src="{{ post.author.icon.url }}" class="icon">
            </div>
            
            <div class="post-content">
                <div class="name">
                    <label>{{ post.author.display_name }}</label> @{{ post.author.username }}
                    <span style="margin-left: auto; font-size: 1rem; color: #d8d8d8;">
                        {{ post.created_at|timesince }}å‰
                    </span>
                    
                    {% if current_user == post.author %}
                    <button class="delete-btn" data-post-id="{{ post.post_id }}">
                        <span class="material-symbols-rounded">delete</span>
                    </button>
                    {% endif %}
                </div>

                <div class="post-body">
                    {{ post.content|linebreaksbr}}
                        {% if post.image %}
                        <div class="post-image">
                            <img src="{{ post.image.url }}" class="post-image-thumbnail" alt="æŠ•ç¨¿ç”»åƒ">
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        {% if post.quoted_post %}
        <div class="unit quoted-unit" data-post-id="{{ post.quoted_post.post_id }}">
            <div class="post quoted-post">
                <div class="icon_background">
                    {% if post.quoted_post.author.icon %}
                        <img src="{{ post.quoted_post.author.icon.url }}" class="icon">
                    {% endif %}
                </div>

                <div class="post-content">
                    <div class="name">
                        <label>{{ post.quoted_post.author.display_name }}</label>
                        @{{ post.quoted_post.author.username }}
                        <span style="margin-left: auto; font-size: 0.9rem; color: #bdbdbd;">
                            {{ post.quoted_post.created_at|timesince }}å‰
                        </span>
                    </div>

                    <div class="post-body">
                        {{ post.quoted_post.content|linebreaksbr }}
                        {% if post.quoted_post.image %}
                            <div class="post-image">
                                <img src="{{ post.quoted_post.image.url }}" alt="quoted image">
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% elif post.repost and not post.quoted_post %}
        <div class="unit quoted-unit">
            <div class="post quoted-post">
                <div class="none"><p>ã“ã®ãƒã‚¹ãƒˆã¯å‰Šé™¤ã•ã‚Œã¦ã„ã¾ã™ã€‚</p></div>
            </div>
        </div>
        {% endif %}
        
        <div class="post-footer">
            <div class="buttons">
                <button class="comment-btn" onclick="location.href='{% url 'posts:detail' post.post_id %}'" style="text-decoration: none;">
                    <span class="material-symbols-rounded" style="font-variation-settings:'FILL' 0; color:#fffffff; margin-left:.4rem; margin-top:.3rem; font-size: 1.5rem; cursor: pointer;">chat_bubble</span><span class="comment-count">{{ post.comment_count }}</span>
                </button>
                <form method="POST" style="display:inline;">
                    {% csrf_token %}
                    {% if post.is_liked %}
                        <button type="button" class="liked like-btn" data-post-id="{{ post.post_id }}" onclick="event.stopPropagation();">
                            <span class="material-symbols-rounded">favorite</span><span class="like-count">{{ post.like_count }}</span>
                        </button>
                    {% else %}
                        <button type="button" class="unlike like-btn" data-post-id="{{ post.post_id }}">
                            <span class="material-symbols-rounded">favorite</span><span class="like-count">{{ post.like_count }}</span>
                        </button>
                    {% endif %}
                </form>
                <button class="quote-btn" data-post-id="{{ post.post_id }}" onclick="event.stopPropagation();">
                    <span class="material-symbols-rounded">repeat</span><span class="quote-count">{{ post.quote_count }}</span>
                </button>
            </div>
            <span>ãƒã‚¹ãƒˆID:{{ post.post_id }}</span>
        </div>
    </div>
        {% if current_user.is_authenticated %}
        <div class="comment-form">
            <span class="material-symbols-rounded" style="font-variation-settings:'FILL' 0; color:#ffffff88; margin-left:.4rem; margin-top:.3rem;">chat_bubble</span>
            <textarea class="autoresize_new" data-post-id="{{ post.post_id }}" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹â€¦"></textarea>
            <button type="button" class="send-comment-btn" data-post-id="{{ post.post_id }}">é€ä¿¡</button>
        </div>
        {% endif %}

        <div class="comment-list" data-post-id="{{ post.post_id }}">
            {% for comment in comments %}
            <div class="comment-unit">
                <div class="comment">
                    <div class="icon_background">
                        {% if comment.author.icon %}
                        <img src="{{ comment.author.icon.url }}" class="icon">
                        {% endif %}
                    </div>
                    <div class="post-content">
                        <div class="name">
                            <label>{{ comment.author.display_name }}</label> @{{ comment.author.username }}<span style="margin-left: auto; font-size: .8rem; color: #ccc;">{{ comment.created_at|timesince }}å‰</span>
                            {% if current_user == comment.author %}
                            <button class="delete-comment-btn" data-comment-id="{{ comment.post_id }}" data-original-post-id="{{ post.post_id }}">
                                <span class="material-symbols-rounded">delete</span>
                            </button>
                            {% endif %}
                        </div>
                        <p class="reply-base"> è¿”ä¿¡å…ˆï¼š @{{ post.author.username }}</p>
                        <div class="post-body">
                            {{ comment.content|linebreaksbr}}
                                {% if comment.image %}
                                <div class="post-image">
                                    <img src="{{ comment.image.url }}" class="post-image-thumbnail" alt="æŠ•ç¨¿ç”»åƒ">
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="post-footer">
                    <div class="buttons">
                        <button class="comment-btn" data-post-id="{{ comment.post_id }}" style="text-decoration: none;">
                            <span class="material-symbols-rounded" style="font-variation-settings:'FILL' 0; color:#fffffff; margin-left:.4rem; margin-top:.3rem; font-size: 1.2rem; cursor: pointer;">chat_bubble</span><span class="comment-count">{{ comment.comment_count }}</span>
                        </button>
                        
                        <form method="POST" style="display:inline;">
                            {% csrf_token %}
                            {% if comment.is_liked %}
                                <button type="button" class="liked like-btn" data-post-id="{{ comment.post_id }}" onclick="event.stopPropagation();">
                                    <span class="material-symbols-rounded">favorite</span><span class="like-count">{{ comment.like_count }}</span>
                                </button>
                            {% else %}
                                <button type="button" class="unlike like-btn" data-post-id="{{ comment.post_id }}">
                                    <span class="material-symbols-rounded">favorite</span><span class="like-count">{{ comment.like_count }}</span>
                                </button>
                            {% endif %}
                        </form>
                        
                        <button class="quote-btn" data-post-id="{{ comment.post_id }}" onclick="event.stopPropagation();">
                            <span class="material-symbols-rounded">repeat</span><span class="quote-count">{{ comment.quote_count }}</span>
                        </button>
                    </div>
                    <span>ã‚³ãƒ¡ãƒ³ãƒˆID:{{ comment.post_id }}</span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

    /* =========================================================
        1) å¼•ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«å‡¦ç†ï¼ˆå…ƒãƒã‚¹ãƒˆè¡¨ç¤ºã¤ãï¼‰
    ========================================================== */

    const modal = document.getElementById("quoteModal");
    const quoteText = document.getElementById("quoteText");
    const quotePostId = document.getElementById("quotePostId");
    const quotedOriginal = document.getElementById("quotedOriginal");

    document.querySelectorAll(".quote-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            event.stopPropagation();

            const postId = btn.dataset.postId;
            quotePostId.value = postId;
            quoteText.value = "";

            const unit = btn.closest(".unit");
            const originalPost = unit.querySelector(".post");
            
            if (originalPost) {
                // 1. originalPost ã®HTMLã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ä¸€æ—¦ã‚³ãƒ³ãƒ†ãƒŠã«ãƒ­ãƒ¼ãƒ‰
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = originalPost.innerHTML;

                // 2. â˜… æŠ•ç¨¿è€…ã®åå‰è¡Œ (.name) ã®ä¸­ã®æ™‚é–“è¡¨ç¤ºè¦ç´ ã‚’æ¤œç´¢ã—ã¦å‰Šé™¤
                // æ™‚é–“è¡¨ç¤ºã¯é€šå¸¸ã€.name divã®æœ«å°¾ã«ã‚ã‚‹ <span> è¦ç´ 
                const timeSpan = tempDiv.querySelector('.name span[style*="margin-left: auto;"]');
                if (timeSpan) {
                    timeSpan.remove();
                }

                // 3. å‰Šé™¤ãƒœã‚¿ãƒ³ãŒã‚ã‚Œã°ãã‚Œã‚‚å‰Šé™¤ï¼ˆå¼•ç”¨å…ƒã«ã¯ä¸è¦ãªãŸã‚ï¼‰
                const deleteBtn = tempDiv.querySelector('.name .delete-btn');
                if (deleteBtn) {
                    deleteBtn.remove();
                }

                // 4. ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã•ã‚ŒãŸHTMLã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«ã«ã‚»ãƒƒãƒˆ
                quotedOriginal.innerHTML = `
                    <div class="quoted-box">
                        ${tempDiv.innerHTML}
                    </div>
                `;
            } else {
                quotedOriginal.innerHTML = "<div class='quoted-box'>ï¼ˆå¼•ç”¨å…ƒã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸï¼‰</div>";
            }

            // CSS Transitionã‚’é©ç”¨ã™ã‚‹ãŸã‚ã€ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ ã™ã‚‹
            modal.classList.add('is-visible');
        });
    });

    // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹
    document.getElementById("closeModal").addEventListener("click", () => {
        // â˜… ä¿®æ­£: CSS Transitionã‚’é©ç”¨ã™ã‚‹ãŸã‚ã€ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤ã™ã‚‹
        // modal.style.display = "none"; <-- å‰Šé™¤
        modal.classList.remove('is-visible');
    });

    // å¼•ç”¨é€ä¿¡
    document.getElementById("sendQuote").addEventListener("click", () => {
        const text = quoteText.value.trim();
        const quotedId = quotePostId.value;
        const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;

        fetch("/posts/quote/", {
            method: "POST",
            headers: {
                "X-CSRFToken": csrfToken,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                text: text,
                quoted_post_id: quotedId
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.ok) {
                // â˜… ä¿®æ­£: CSS Transitionã‚’é©ç”¨ã™ã‚‹ãŸã‚ã€ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤ã™ã‚‹
                // modal.style.display = "none"; <-- å‰Šé™¤
                modal.classList.remove('is-visible');
                location.reload();
            }
        });
    });

    /* =========================================================
        2) è‡ªå‹•ãƒªã‚µã‚¤ã‚º
    ========================================================== */

    document.querySelectorAll('.autoresize, .autoresize_new').forEach(textarea => {
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';

        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        });
    });

    /* =========================================================
        3) ã„ã„ã­
    ========================================================== */

    document.querySelectorAll(".like-btn").forEach(button => {
        button.addEventListener("click", function() {

            const postId = this.dataset.postId;
            const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;
            const btn = this;

            fetch("{% url 'posts:toggle_like' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": csrfToken,
                    "Content-Type": "application/x-www-form-urlencoded",
                },
                body: `post_id=${postId}`
            })
            .then(res => res.json())
            .then(data => {
                if (!data.error) {
                    btn.classList.toggle("liked", data.is_liked);
                    btn.classList.toggle("unlike", !data.is_liked);

                    const count = btn.querySelector(".like-count");
                    count.textContent = data.like_count;
                }
            });
        });
    });

    /* =========================================================
        4) ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ (Postãƒ¢ãƒ‡ãƒ«å¯¾å¿œç‰ˆ)
    ========================================================== */

    document.querySelectorAll(".send-comment-btn").forEach(button => {
        button.addEventListener("click", () => {
            const postId = button.dataset.postId;
            const textarea = document.querySelector(`.autoresize_new[data-post-id="${postId}"]`);
            const text = textarea.value.trim();
            const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;

            if (!text) {
                // ã‚³ãƒ¡ãƒ³ãƒˆãŒç©ºã®å ´åˆã¯å‡¦ç†ã‚’çµ‚äº†
                return;
            }

            const formData = new FormData();
            formData.append("text", text);

            fetch(`/add_comment/${postId}/`, {
                method: "POST",
                headers: { "X-CSRFToken": csrfToken },
                body: formData
            })
            .then(res => {
                // HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒæ­£å¸¸ã‹ãƒã‚§ãƒƒã‚¯
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                return res.json();
            })
            .then(data => {
                if (data.error) {
                    console.error("ã‚µãƒ¼ãƒãƒ¼ãŒã‚¨ãƒ©ãƒ¼ã‚’è¿”ã—ã¾ã—ãŸ:", data.error);
                    return;
                }

                // æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ãƒã‚§ãƒƒã‚¯ (data.ok)
                if (data.ok) { 
                    const commentList = document.querySelector(`.comment-list[data-post-id="${postId}"]`);

                    // ã‚³ãƒ¡ãƒ³ãƒˆæ•°è¡¨ç¤ºè¦ç´ ã®æ­£ç¢ºãªå–å¾—
                    const commentCountElement = document.querySelector(`.comment-count[data-post-id="${postId}"]`);
                    
                    // ã‚³ãƒ¡ãƒ³ãƒˆã‚’ DOM ã«è¿½åŠ 
                    const newComment = document.createElement("div");
                    newComment.classList.add("comment");
                    
                    // ã‚³ãƒ¡ãƒ³ãƒˆHTMLã‚’ç”Ÿæˆ
                    newComment.innerHTML = `
                        <div class="icon_background">
                            ${data.icon_url ? `<img src="${data.icon_url}" class="icon">` : ""}
                        </div>
                        <div class="post-content">
                            <div class="name">
                                <label>${data.display_name}</label> @${data.username}
                                </div>
                            <p class="reply-base"> è¿”ä¿¡å…ˆï¼š @${data.original_author_username || ''}</p> 
                            <div class="post-body">
                                ${data.content.replace(/\n/g, '<br>')} </div>
                        </div>
                    `;

                    // â˜…â˜…â˜… newComment ã¯ã“ã“ã§å®šç¾©ãƒ»ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ReferenceErrorã¯ç™ºç”Ÿã—ãªã„ã¯ãš â˜…â˜…â˜…
                    commentList.prepend(newComment);
                    textarea.value = ""; // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢
                    
                    // ã‚³ãƒ¡ãƒ³ãƒˆæ•°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’æ›´æ–°
                    if (commentCountElement && data.comment_count !== undefined) {
                        commentCountElement.textContent = data.comment_count;
                    }
                }
            })
            .catch(error => {
                console.error("ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ä¸­ã«è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
            });
        });
    });
    
    /* =========================================================
        5) æŠ•ç¨¿å‰Šé™¤
    ========================================================== */

    document.querySelectorAll(".delete-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            if (!confirm("ã“ã®ãƒã‚¹ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;

            const postId = btn.dataset.postId;
            const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;

            fetch(`/delete/${postId}/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": csrfToken,
                    "Content-Type": "application/json"
                }
            })
            .then(res => res.json())
            .then(data => {
                if (data.ok) {
                    // å‰Šé™¤å¯¾è±¡ã®æŠ•ç¨¿ã‚’ç”»é¢ã‹ã‚‰æ¶ˆã™
                    const unit = btn.closest(".unit");
                    if (unit) unit.remove();
                }
            });
        });
    });

        /* =========================================================
        5) ã‚³ãƒ¡ãƒ³ãƒˆå‰Šé™¤
    ========================================================== */

    document.querySelectorAll(".delete-comment-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            if (!confirm("ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                return;
            }

            const commentId = btn.dataset.commentId;
            const originalPostId = btn.dataset.originalPostId; // ã‚³ãƒ¡ãƒ³ãƒˆæ•°æ›´æ–°ç”¨
            const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;
            const parentComment = btn.closest(".comment"); // å‰Šé™¤å¯¾è±¡ã®ã‚³ãƒ¡ãƒ³ãƒˆè¦ç´ 

            fetch(`/delete/${commentId}/`, { // æ—¢å­˜ã® delete_post ãƒ“ãƒ¥ãƒ¼ã‚’å†åˆ©ç”¨
                method: "POST",
                headers: {
                    "X-CSRFToken": csrfToken,
                    "Content-Type": "application/json"
                }
            })
            .then(res => res.json())
            .then(data => {
                if (data.ok) {
                    // 1. ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”»é¢ã‹ã‚‰å‰Šé™¤
                    if (parentComment) {
                        parentComment.remove();
                    }
                    
                    // 2. ã‚³ãƒ¡ãƒ³ãƒˆæ•°ã‚’æ›´æ–°
                    if (data.new_comment_count !== undefined) {
                        const commentCountElement = document.querySelector(`.comment-count[data-post-id="${originalPostId}"]`);
                        if (commentCountElement) {
                            commentCountElement.textContent = data.new_comment_count;
                        }
                    }
                } else {
                    console.error("ã‚³ãƒ¡ãƒ³ãƒˆå‰Šé™¤å¤±æ•—:", data.error);
                }
            })
            .catch(error => {
                console.error("ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼:", error);
            });
        });
    });

    /* =========================================================
        6) ãƒ­ã‚°ã‚¢ã‚¦ãƒˆè­¦å‘Š
    ========================================================== */

    document.querySelector(".logout-form").addEventListener("submit", function(event) {
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãŸå ´åˆã€ãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡ã‚’ä¸­æ­¢ã™ã‚‹
        if (!confirm("æœ¬å½“ã«ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ")) {
            event.preventDefault(); // ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®é€ä¿¡å‹•ä½œã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        }
    });

    /* =========================================================
        ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ (æœ€çµ‚å®‰å®šç‰ˆ)
    ========================================================== */
    const imageInput = document.getElementById('id_image'); 
    const imageIcon = document.getElementById('image-upload-icon'); 
    const previewWrapper = document.getElementById('post-image-wrapper');
    const previewImage = document.getElementById('preview-image');
    const clearImageBtn = document.getElementById('clear-image-btn');
    
    // ğŸ’¡ ã‚¢ã‚¤ã‚³ãƒ³ã®åˆæœŸè‰²ã‚’å®šç¾© (ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®CSSã«åˆã‚ã›ã¦é©å®œå¤‰æ›´ã—ã¦ãã ã•ã„)
    const INITIAL_ICON_COLOR = '#ffffff88'; 
    const SUCCESS_ICON_COLOR = '#4CAF50'; 

    if (imageInput && imageIcon && previewWrapper && previewImage && clearImageBtn) {
        
        // 1. ã‚¢ã‚¤ã‚³ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ã
        imageIcon.addEventListener('click', function() {
            imageInput.click(); // éš ã•ã‚ŒãŸ input ã‚’å¼·åˆ¶çš„ã«ã‚¯ãƒªãƒƒã‚¯
        });
        
        // 2. ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå¾Œã® 'change' ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼/ãƒªã‚»ãƒƒãƒˆã®æœ¬ä½“ï¼‰
        imageInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            
            if (file) {
                // ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆ: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤ºã—ã€ã‚¢ã‚¤ã‚³ãƒ³ã‚’ç·‘è‰²ã«ã™ã‚‹
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImage.src = e.target.result;
                    // CSSã®ä¸Šæ›¸ãã‚’å›é¿ã™ã‚‹ãŸã‚ã€!importantã§å¼·åˆ¶è¡¨ç¤º
                    previewWrapper.style.setProperty('display', 'block', 'important'); 
                };
                reader.readAsDataURL(file);
                imageIcon.style.color = SUCCESS_ICON_COLOR;
                clearImageBtn.style.display = 'block'; // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            } else {
                // ãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„å ´åˆ: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’éè¡¨ç¤ºã«ã—ã€ã‚¢ã‚¤ã‚³ãƒ³ã‚’åˆæœŸè‰²ã«æˆ»ã™
                previewWrapper.style.setProperty('display', 'none', 'important');
                imageIcon.style.color = INITIAL_ICON_COLOR;
                clearImageBtn.style.display = 'none'; // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
            }
        });

        // 3. ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ (ãƒãƒ„ãƒœã‚¿ãƒ³ã®å‡¦ç†)
        clearImageBtn.addEventListener('click', function() {
            // ğŸš¨ ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆã“ã‚Œã«ã‚ˆã£ã¦ files.length ãŒ 0 ã«ãªã‚‹ï¼‰
            imageInput.value = ''; 

            // ğŸ’¡ change ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ‰‹å‹•ã§ç™ºç«ã•ã›ã‚‹
            //    ã“ã‚Œã«ã‚ˆã‚Šã€ä¸Šè¨˜ã® if/else ãƒ­ã‚¸ãƒƒã‚¯ã® 'else' ãƒ–ãƒ­ãƒƒã‚¯ãŒå®Ÿè¡Œã•ã‚Œã€
            //    ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼éè¡¨ç¤ºã¨ã‚¢ã‚¤ã‚³ãƒ³è‰²ãƒªã‚»ãƒƒãƒˆãŒä¸€æ‹¬ã§è¡Œã‚ã‚Œã‚‹ã€‚
            imageInput.dispatchEvent(new Event('change')); 
        });

    } else {
        console.error("ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚HTMLè¦ç´ ã®IDã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    }

    /* =========================================================
        7) ç”»åƒãƒ¢ãƒ¼ãƒ€ãƒ«å‡¦ç†
    ========================================================== */
    const imageModal = document.getElementById('imageModal');
    const modalImage = document.getElementById('modalImage');
    const closeImageModal = document.getElementById('closeImageModal');
    const thumbnails = document.querySelectorAll('.post-image-thumbnail'); // å…¨ã¦ã®æŠ•ç¨¿ç”»åƒã‚’å–å¾—

    // 1. ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã®å‡¦ç†
    thumbnails.forEach(thumbnail => {
        thumbnail.addEventListener('click', function() {
            // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸç”»åƒã® URL ã‚’å–å¾—
            const imageUrl = this.src; 
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ç”»åƒã« URL ã‚’è¨­å®š
            modalImage.src = imageUrl; 
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            imageModal.style.display = 'block';
        });
    });

    // 2. é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ (Ã—) ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã®å‡¦ç†
    closeImageModal.addEventListener('click', function() {
        imageModal.style.display = 'none';
    });

    // 3. ãƒ¢ãƒ¼ãƒ€ãƒ«ã®èƒŒæ™¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã®å‡¦ç† (ãƒ¢ãƒ¼ãƒ€ãƒ«å…¨ä½“)
    imageModal.addEventListener('click', function(e) {
        // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸè¦ç´ ãŒãƒ¢ãƒ¼ãƒ€ãƒ«è‡ªèº«ï¼ˆèƒŒæ™¯ï¼‰ã§ã‚ã‚Œã°é–‰ã˜ã‚‹
        if (e.target === imageModal) {
            imageModal.style.display = 'none';
        }
    });
});
</script>

{% endblock %}
