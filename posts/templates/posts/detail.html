{% extends "posts/base.html" %}
{% load static %}

{% block title %}"{{ post.content|linebreaksbr}}" by {{ post.author.display_name }} | Sparrow{% endblock %}

{% block extra_style %}
<link rel="preload" href="{% static 'posts/detail.css' %}" as="style">
<link rel="stylesheet" href="{% static 'posts/detail.css' %}">
{% endblock %}

{% block content %}

<div id="quoteModal">
    <div class="modal-content">
        <textarea id="quoteText" placeholder="コメントを追加する..."></textarea>
        <input type="hidden" id="quotePostId">
        <div id="quotedOriginal" style="padding:.6rem; border-left:3px solid #8885; margin-bottom:1rem;"></div>
        <div style="display:flex; justify-content:space-between; gap:.6rem; margin-top:.8rem;">
            <button id="closeModal" class="basic" style="background-color:#ff492d;">閉じる</button>
            <button id="sendQuote" class="basic">ポスト</button>
        </div>
    </div>
</div>

<div class="login_status">
    <div class="status">
        <div class="icon_background">
            {% if current_user.icon %}
                <img src="{{ current_user.icon.url }}" class="icon">
            {% endif %}
        </div>
        {% if current_user.is_authenticated %}
        <div class="user">
            <div class="name"><label>{{ current_user.display_name }}</label> @{{ current_user.username }}</div>
        {% endif %}
        </div>
    </div>
    {% if current_user.is_authenticated %}
    <form action="{% url 'accounts:logout' %}" method="post" class="logout-form">
        {% csrf_token %}
        <button type="submit" class="logout-button">ログアウト</button>
    </form>
    {% endif %}
</div>

<div class="posts-wrapper">
    <h2 style="color: #fff; margin-bottom: 1rem;">ポスト詳細</h2>

    {% if ancestor_posts_path %}
        {% for ancestor in ancestor_posts_path %}
        <div class="unit ancestor-unit" data-post-id="{{ ancestor.post_id }}">
            <div class="hierarchy-connect"></div>
            <div class="post" style="cursor: pointer;">
                <div class="icon_background">
                    {% if ancestor.author.icon %}
                        <img src="{{ ancestor.author.icon.url }}" class="icon">
                    {% endif %}
                </div>
                
                <div class="post-content">
                    <div class="name">
                        <label>{{ ancestor.author.display_name }}</label> @{{ ancestor.author.username }}
                        <span style="margin-left: auto; font-size: 0.8rem; color: #8d8d8d;">
                            {{ ancestor.created_at|timesince }}前
                        </span>
                    </div>
                    
                    <div class="post-body">
                        {{ ancestor.content|linebreaksbr|truncatechars:100 }}
                        {% if ancestor.image %}
                            <div class="post-image">
                                <img src="{{ ancestor.image.url }}" class="post-image-thumbnail" alt="投稿画像">
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="post-footer ancestor-footer">
                <div class="buttons">
                    <button class="comment-btn" onclick="location.href='{% url 'posts:detail' ancestor.post_id %}'" style="text-decoration: none;">
                        <span class="material-symbols-rounded" style="font-variation-settings:'FILL' 0; color:#fffffff; margin-left:.4rem; margin-top:.3rem; font-size: 1.5rem; cursor: pointer;">chat_bubble</span><span class="comment-count">{{ ancestor.comment_count }}</span>
                    </button>
                    
                    <form method="POST" style="display:inline;">
                        {% csrf_token %}
                        {% if ancestor.is_liked %}
                            <button type="button" class="liked like-btn" data-post-id="{{ ancestor.post_id }}">
                                <span class="material-symbols-rounded">favorite</span><span class="like-count">{{ ancestor.like_count }}</span>
                            </button>
                        {% else %}
                            <button type="button" class="unlike like-btn" data-post-id="{{ ancestor.post_id }}">
                                <span class="material-symbols-rounded">favorite</span><span class="like-count">{{ ancestor.like_count }}</span>
                            </button>
                        {% endif %}
                    </form>
                    
                    <button class="quote-btn" data-post-id="{{ ancestor.post_id }}">
                        <span class="material-symbols-rounded">repeat</span><span class="quote-count">{{ ancestor.quote_count }}</span>
                    </button>
                </div>
                <span>ポストID:{{ ancestor.post_id }}</span>
            </div>
            <a href='{% url 'posts:detail' ancestor.post_id %}' class="post-link"></a>
        </div>

        {% endfor %}
    {% endif %}
    <div class="unit"> 
        <div class="post">
            <div class="icon_background">
                {% if post.author.icon %}
                <img src="{{ post.author.icon.url }}" class="icon">
                {% endif %}
            </div>
            
            <div class="post-content">
                <div class="name">
                    <label>{{ post.author.display_name }}</label> @{{ post.author.username }}
                    <span style="margin-left: auto; font-size: 1rem; color: #d8d8d8;">
                        {{ post.created_at|timesince }}前
                    </span>
                    
                    {% if current_user == post.author %}
                    <button class="delete-btn" data-post-id="{{ post.post_id }}">
                        <span class="material-symbols-rounded">delete</span>
                    </button>
                    {% endif %}
                </div>

                <div class="post-body">
                    {{ post.content|linebreaksbr}}
                        {% if post.image %}
                        <div class="post-image">
                            <img src="{{ post.image.url }}" class="post-image-thumbnail" alt="投稿画像">
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        {% if post.quoted_post %}
        <div class="unit quoted-unit" data-post-id="{{ post.quoted_post.post_id }}">
            <div class="post quoted-post">
                <div class="icon_background">
                    {% if post.quoted_post.author.icon %}
                        <img src="{{ post.quoted_post.author.icon.url }}" class="icon">
                    {% endif %}
                </div>

                <div class="post-content">
                    <div class="name">
                        <label>{{ post.quoted_post.author.display_name }}</label>
                        @{{ post.quoted_post.author.username }}
                        <span style="margin-left: auto; font-size: 0.9rem; color: #bdbdbd;">
                            {{ post.quoted_post.created_at|timesince }}前
                        </span>
                    </div>

                    <div class="post-body">
                        {{ post.quoted_post.content|linebreaksbr }}
                        {% if post.quoted_post.image %}
                            <div class="post-image">
                                <img src="{{ post.quoted_post.image.url }}" alt="quoted image">
                            </div>
                        {% endif %}
                    </div>
                </div>
                <a href="{% url 'posts:detail' post.quoted_post.post_id %}" class="post-link"></a>
            </div>
        </div>
        {% elif post.repost and not post.quoted_post %}
        <div class="unit quoted-unit">
            <div class="post quoted-post">
                <div class="none"><p>このポストは削除されています。</p></div>
            </div>
        </div>
        {% endif %}
        
        <div class="post-footer">
            <div class="buttons">
                <button class="comment-btn" onclick="location.href='{% url 'posts:detail' post.post_id %}'" style="text-decoration: none;">
                    <span class="material-symbols-rounded" style="font-variation-settings:'FILL' 0; color:#fffffff; margin-left:.4rem; margin-top:.3rem; font-size: 1.5rem; cursor: pointer;">chat_bubble</span><span class="comment-count">{{ post.comment_count }}</span>
                </button>
                <form method="POST" style="display:inline;">
                    {% csrf_token %}
                    {% if post.is_liked %}
                        <button type="button" class="liked like-btn" data-post-id="{{ post.post_id }}" >
                            <span class="material-symbols-rounded">favorite</span><span class="like-count">{{ post.like_count }}</span>
                        </button>
                    {% else %}
                        <button type="button" class="unlike like-btn" data-post-id="{{ post.post_id }}">
                            <span class="material-symbols-rounded">favorite</span><span class="like-count">{{ post.like_count }}</span>
                        </button>
                    {% endif %}
                </form>
                <button class="quote-btn" data-post-id="{{ post.post_id }}">
                    <span class="material-symbols-rounded">repeat</span><span class="quote-count">{{ post.quote_count }}</span>
                </button>
            </div>
            <span>ポストID:{{ post.post_id }}</span>
        </div>
    </div>
    
    {% if current_user.is_authenticated %}
    <div class="comment-form">
        <span class="material-symbols-rounded" style="font-variation-settings:'FILL' 0; color:#ffffff88; margin-left:.4rem; margin-top:.3rem;">chat_bubble</span>
        <textarea class="autoresize_new" data-post-id="{{ post.post_id }}" placeholder="コメントする…"></textarea>
        <button type="button" class="send-comment-btn" data-post-id="{{ post.post_id }}">送信</button>
    </div>
    {% endif %}

    <div class="comment-list" data-post-id="{{ post.post_id }}">
        {% for comment in comments %}
        <div class="comment-unit">
            <div class="comment">
                <div class="icon_background">
                    {% if comment.author.icon %}
                    <img src="{{ comment.author.icon.url }}" class="icon">
                    {% endif %}
                </div>
                <div class="post-content">
                    <div class="name">
                        <label>{{ comment.author.display_name }}</label> @{{ comment.author.username }}<span style="margin-left: auto; font-size: .8rem; color: #ccc;">{{ comment.created_at|timesince }}前</span>
                        {% if current_user.post_id == comment.author.id %}
                        <button class="delete-comment-btn" data-comment-id="{{ comment.post_id }}" data-original-post-id="{{ post.post_id }}">
                            <span class="material-symbols-rounded">delete</span>
                        </button>
                        {% endif %}
                    </div>
                    <div class="post-body">
                        {{ comment.content|linebreaksbr}}
                            {% if comment.image %}
                            <div class="post-image">
                                <img src="{{ comment.image.url }}" class="post-image-thumbnail" alt="投稿画像">
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="post-footer">
                <div class="buttons">
                    <button class="comment-btn" data-post-id="{{ comment.post_id }}" style="text-decoration: none;">
                        <span class="material-symbols-rounded" style="font-variation-settings:'FILL' 0; color:#fffffff; margin-left:.4rem; margin-top:.3rem; font-size: 1.2rem; cursor: pointer;">chat_bubble</span><span class="comment-count">{{ comment.comment_count }}</span>
                    </button>
                    
                    <form method="POST" style="display:inline;">
                        {% csrf_token %}
                        {% if comment.is_liked %}
                            <button type="button" class="liked like-btn" data-post-id="{{ comment.post_id }}">
                                <span class="material-symbols-rounded">favorite</span><span class="like-count">{{ comment.like_count }}</span>
                            </button>
                        {% else %}
                            <button type="button" class="unlike like-btn" data-post-id="{{ comment.post_id }}">
                                <span class="material-symbols-rounded">favorite</span><span class="like-count">{{ comment.like_count }}</span>
                            </button>
                        {% endif %}
                    </form>
                    
                    <button class="quote-btn" data-post-id="{{ comment.post_id }}">
                        <span class="material-symbols-rounded">repeat</span><span class="quote-count">{{ comment.quote_count }}</span>
                    </button>
                </div>
                <span>コメントID:{{ comment.post_id }}</span>
            </div>
            <a href="{% url 'posts:detail' comment.post_id %}" class="post-link"></a>
        </div>
        {% endfor %}
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

    /* =========================================================
        共通要素の取得
    ========================================================== */

    const modal = document.getElementById("quoteModal");
    const quoteText = document.getElementById("quoteText");
    const quotePostId = document.getElementById("quotePostId");
    const quotedOriginal = document.getElementById("quotedOriginal");
    const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;

    /* =========================================================
        A) イベントハンドラ関数 (共通ロジック)
    ========================================================== */

    /**
     * いいね/いいね解除処理を実行する共通ハンドラ
     */
    function handleLikeToggle(event) {
        event.preventDefault(); // 親フォームの送信を停止
        event.stopPropagation(); // 親リンク/要素への伝播を停止
        
        const btn = this;
        const postId = btn.dataset.postId;

        fetch("{% url 'posts:toggle_like' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": csrfToken,
                "Content-Type": "application/x-www-form-urlencoded",
            },
            body: `post_id=${postId}`
        })
        .then(res => res.json())
        .then(data => {
            if (!data.error) {
                btn.classList.toggle("liked", data.is_liked);
                btn.classList.toggle("unlike", !data.is_liked);

                const count = btn.querySelector(".like-count");
                count.textContent = data.like_count;
            }
        });
    }

    /**
     * 引用モーダルを開く処理を実行する共通ハンドラ
     */
    function handleQuoteClick(event) {
        event.preventDefault();
        event.stopPropagation();
        
        const btn = this;
        const postId = btn.dataset.postId;
        
        quotePostId.value = postId;
        quoteText.value = "";
        
        const unit = btn.closest(".unit, .comment-unit"); 
        const originalPost = unit ? unit.querySelector(".post, .comment") : null;

        if (originalPost) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = originalPost.innerHTML;

            const timeSpan = tempDiv.querySelector('.name span[style*="margin-left: auto;"]');
            if (timeSpan) timeSpan.remove();

            const deleteBtns = tempDiv.querySelectorAll('.name .delete-btn, .name .delete-comment-btn');
            deleteBtns.forEach(dBtn => dBtn.remove());

            quotedOriginal.innerHTML = `<div class="quoted-box">${tempDiv.innerHTML}</div>`;
        } else {
            quotedOriginal.innerHTML = "<div class='quoted-box'>（引用元を取得できませんでした）</div>";
        }
        modal.classList.add('is-visible');
    }

    /**
     * コメント削除処理を実行する共通ハンドラ
     */
    function handleDeleteComment() {
        if (!confirm("このコメントを削除しますか？")) return;

        const commentId = this.dataset.commentId;
        const originalPostId = this.dataset.originalPostId;
        const parentCommentUnit = this.closest(".comment-unit");

        fetch(`/delete/${commentId}/`, { 
            method: "POST",
            headers: {
                "X-CSRFToken": csrfToken,
                "Content-Type": "application/json"
            }
        })
        .then(res => res.json())
        .then(data => {
            if (data.ok) {
                if (parentCommentUnit) parentCommentUnit.remove();
                
                if (data.new_comment_count !== undefined) {
                    const mainPostCommentCountElement = document.querySelector(`.unit .post-footer .comment-count`); 
                    if (mainPostCommentCountElement) {
                        mainPostCommentCountElement.textContent = data.new_comment_count;
                    }
                }
            } else {
                console.error("コメント削除失敗:", data.error);
            }
        });
    }


    /* =========================================================
        B) イベントリスナー登録関数 (共通化)
    ========================================================== */

    /**
     * 指定されたスコープ内のいいねボタンにリスナーを登録
     */
    function setupLikeButtons(scope = document) {
        scope.querySelectorAll(".like-btn").forEach(button => {
            button.removeEventListener('click', handleLikeToggle);
            button.addEventListener("click", handleLikeToggle);
        });
    }

    /**
     * 指定されたスコープ内の引用ボタンにリスナーを登録
     */
    function setupQuoteButtons(scope = document) {
        scope.querySelectorAll(".quote-btn").forEach(btn => {
            btn.removeEventListener('click', handleQuoteClick);
            btn.addEventListener("click", handleQuoteClick);
        });
    }

    /**
     * 指定されたスコープ内のコメント削除ボタンにリスナーを登録
     */
    function setupDeleteCommentButtons(scope = document) {
        scope.querySelectorAll(".delete-comment-btn").forEach(btn => {
            btn.removeEventListener('click', handleDeleteComment);
            btn.addEventListener("click", handleDeleteComment);
        });
    }

    /**
     * 動的に追加された要素に全てのリスナーを登録する統合関数
     */
    function attachEventListeners(newElement) {
        setupLikeButtons(newElement);
        setupQuoteButtons(newElement);
        setupDeleteCommentButtons(newElement);
    }


    /* =========================================================
        1. 初期ロード時のイベント登録
    ========================================================== */
    setupLikeButtons();
    setupQuoteButtons();
    setupDeleteCommentButtons(); // 既存のコメント削除ボタンにも適用

    /* =========================================================
        2. 引用モーダル処理 (1)
    ========================================================== */

    document.getElementById("closeModal").addEventListener("click", () => {
        modal.classList.remove('is-visible');
    });

    document.getElementById("sendQuote").addEventListener("click", () => {
        const text = quoteText.value.trim();
        const quotedId = quotePostId.value;

        fetch("/posts/quote/", {
            method: "POST",
            headers: {
                "X-CSRFToken": csrfToken,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                text: text,
                quoted_post_id: quotedId
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.ok) {
                modal.classList.remove('is-visible');
                location.reload();
            }
        });
    });


    /* =========================================================
        3. コメント投稿処理 (4)
    ========================================================== */

    document.querySelectorAll(".send-comment-btn").forEach(button => {
        button.addEventListener("click", () => {
            const postId = button.dataset.postId;
            const textarea = document.querySelector(`.autoresize_new[data-post-id="${postId}"]`);
            const text = textarea.value.trim();

            if (!text) return;

            const formData = new FormData();
            formData.append("text", text);

            fetch(`/add_comment/${postId}/`, {
                method: "POST",
                headers: { "X-CSRFToken": csrfToken },
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.ok) { 
                    const commentList = document.querySelector(`.comment-list[data-post-id="${postId}"]`);
                    const mainPostCommentCountElement = document.querySelector(`.unit .post-footer .comment-count`); 
                    
                    const newCommentUnit = document.createElement("div");
                    newCommentUnit.classList.add("comment-unit");
                    
                    // 新しいコメントのHTMLを生成
                    newCommentUnit.innerHTML = `
                        <div class="comment">
                            <div class="icon_background">
                                ${data.icon_url ? `<img src="${data.icon_url}" class="icon">` : "{% if current_user.icon %}<img src='{% static 'images/default_icon.png' %}' class='icon'>{% endif %}"}
                            </div>
                            <div class="post-content">
                                <div class="name">
                                    <label>${data.display_name}</label> @${data.username}<span style="margin-left: auto; font-size: .8rem; color: #ccc;">今</span>
                                    {% if current_user.is_authenticated %}
                                    <button class="delete-comment-btn" data-comment-id="${data.post_id}" data-original-post-id="${postId}">
                                        <span class="material-symbols-rounded">delete</span>
                                    </button>
                                    {% endif %}
                                </div>
                                <div class="post-body">
                                    ${data.content.replace(/\n/g, '<br>')}
                                </div>
                            </div>
                        </div>
                        <div class="post-footer">
                            <div class="buttons">
                                <button class="comment-btn" data-post-id="${data.post_id}" style="text-decoration: none;">
                                    <span class="material-symbols-rounded" style="font-variation-settings:'FILL' 0; color:#fffffff; margin-left:.4rem; margin-top:.3rem; font-size: 1.2rem; cursor: pointer;">chat_bubble</span><span class="comment-count">0</span>
                                </button>
                                
                                <form method="POST" style="display:inline;">
                                    {% csrf_token %}
                                    <button type="button" class="unlike like-btn" data-post-id="${data.post_id}">
                                        <span class="material-symbols-rounded">favorite</span><span class="like-count">0</span>
                                    </button>
                                </form>
                                
                                <button class="quote-btn" data-post-id="${data.post_id}" onclick="event.stopPropagation();">
                                    <span class="material-symbols-rounded">repeat</span><span class="quote-count">0</span>
                                </button>
                            </div>
                            <span>コメントID:${data.post_id}</span>
                        </div>
                        <a href="/posts/${data.post_id}/" class="post-link"></a>
                    `;

                    commentList.prepend(newCommentUnit);
                    textarea.value = "";
                    
                    if (mainPostCommentCountElement && data.comment_count !== undefined) {
                        mainPostCommentCountElement.textContent = data.comment_count;
                    }
                    
                    // 新しく追加した要素に全てのリスナーをアタッチ
                    attachEventListeners(newCommentUnit);
                }
            })
            .catch(error => {
                console.error("コメント投稿中に致命的なエラーが発生しました:", error);
            });
        });
    });


    /* =========================================================
        4. 投稿削除処理 (5)
    ========================================================== */

    document.querySelectorAll(".delete-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            if (!confirm("このポストを削除しますか？")) return;

            const postId = btn.dataset.postId;

            fetch(`/delete/${postId}/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": csrfToken,
                    "Content-Type": "application/json"
                }
            })
            .then(res => res.json())
            .then(data => {
                if (data.ok) {
                    const unit = btn.closest(".unit");
                    if (unit) unit.remove();
                }
            });
        });
    });


    /* =========================================================
        5. 自動リサイズ (2)
    ========================================================== */

    document.querySelectorAll('.autoresize, .autoresize_new').forEach(textarea => {
        // 初期リサイズ
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';

        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        });
    });


    /* =========================================================
        6. ログアウト警告 (6)
    ========================================================== */

    document.querySelector(".logout-form").addEventListener("submit", function(event) {
        if (!confirm("本当にログアウトしますか？")) {
            event.preventDefault();
        }
    });

    
    /* =========================================================
        7. 画像プレビュー機能
    ========================================================== */
    const imageInput = document.getElementById('id_image'); 
    const imageIcon = document.getElementById('image-upload-icon'); 
    const previewWrapper = document.getElementById('post-image-wrapper');
    const previewImage = document.getElementById('preview-image');
    const clearImageBtn = document.getElementById('clear-image-btn');
    
    const INITIAL_ICON_COLOR = '#ffffff88'; 
    const SUCCESS_ICON_COLOR = '#4CAF50'; 

    if (imageInput && imageIcon && previewWrapper && previewImage && clearImageBtn) {
        
        imageIcon.addEventListener('click', function() {
            imageInput.click();
        });
        
        imageInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImage.src = e.target.result;
                    previewWrapper.style.setProperty('display', 'block', 'important'); 
                };
                reader.readAsDataURL(file);
                imageIcon.style.color = SUCCESS_ICON_COLOR;
                clearImageBtn.style.display = 'block';
            } else {
                previewWrapper.style.setProperty('display', 'none', 'important');
                imageIcon.style.color = INITIAL_ICON_COLOR;
                clearImageBtn.style.display = 'none';
            }
        });

        clearImageBtn.addEventListener('click', function() {
            imageInput.value = ''; 
            imageInput.dispatchEvent(new Event('change')); 
        });
    }

    /* =========================================================
        8. 画像モーダル処理 (7)
    ========================================================== */
    const imageModal = document.getElementById('imageModal');
    const modalImage = document.getElementById('modalImage');
    const closeImageModal = document.getElementById('closeImageModal');
    const thumbnails = document.querySelectorAll('.post-image-thumbnail');

    thumbnails.forEach(thumbnail => {
        thumbnail.addEventListener('click', function() {
            const imageUrl = this.src; 
            modalImage.src = imageUrl; 
            imageModal.style.display = 'block';
        });
    });

    closeImageModal.addEventListener('click', function() {
        imageModal.style.display = 'none';
    });

    imageModal.addEventListener('click', function(e) {
        if (e.target === imageModal) {
            imageModal.style.display = 'none';
        }
    });
});
</script>

{% endblock %}
