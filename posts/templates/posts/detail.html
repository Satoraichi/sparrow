{% extends "posts/base.html" %}
{% load static %}

{% block title %}ポスト | Sparrow{% endblock %}

{% block extra_style %}
<link rel="stylesheet" href="{% static 'posts/detail.css' %}">
{% endblock %}

{% block content %}

<div id="quoteModal">
    <div class="modal-content">
        <textarea id="quoteText" placeholder="コメントを追加する..."></textarea>
        <input type="hidden" id="quotePostId">
        <div id="quotedOriginal" style="padding:.6rem; border-left:3px solid #8885; margin-bottom:1rem;"></div>
        <div style="display:flex; justify-content:space-between; gap:.6rem; margin-top:.8rem;">
            <button id="closeModal" class="basic" style="background-color:#ff492d;">閉じる</button>
            <button id="sendQuote" class="basic">ポスト</button>
        </div>
    </div>
</div>

<div class="login_status">
    <div class="status">
        <div class="icon_background">
            {% if current_user.icon %}
                <img src="{{ current_user.icon.url }}" class="icon">
            {% endif %}
        </div>
        {% if current_user.is_authenticated %}
        <div class="user">
            <div class="name"><label>{{ current_user.display_name }}</label> @{{ current_user.username }}</div>
        {% endif %}
        </div>
    </div>
    {% if current_user.is_authenticated %}
    <form action="{% url 'accounts:logout' %}" method="post" class="logout-form">
        {% csrf_token %}
        <button type="submit" class="logout-button">ログアウト</button>
    </form>
    {% endif %}
</div>

<div class="posts-wrapper">
    <h2 style="color: #fff; margin-bottom: 1rem;">ポスト詳細</h2>

    <div class="unit"> 
        <div class="post">
            <div class="icon_background">
                <img src="{{ post.author.icon.url }}" class="icon">
            </div>
            
            <div class="post-content">
                <div class="name">
                    <label>{{ post.author.display_name }}</label> @{{ post.author.username }}
                    <span style="margin-left: auto; font-size: 1rem; color: #d8d8d8;">
                        {{ post.created_at|timesince }}前
                    </span>
                    
                    {% if current_user == post.author %}
                    <button class="delete-btn" data-post-id="{{ post.post_id }}">
                        <span class="material-symbols-rounded">delete</span>
                    </button>
                    {% endif %}
                </div>

                <div class="post-body">
                    {{ post.content|linebreaksbr}}
                    {% if post.image %}
                        <p style="color: yellow; font-size: 0.8rem;">
                            画像ファイルがDBにあります: 
                            <a href="{{ post.image.url }}" target="_blank">{{ post.image.url }}</a>
                        </p>
                        
                        <div class="post-image">
                            <img src="{{ post.image.url }}" alt="投稿画像" >
                        </div>
                    {% else %}
                        <p style="color: gray; font-size: 0.8rem;">画像ファイルなし</p>
                    {% endif %}
                    </div>
                    </div>
            </div>
        </div>
        
        {% if post.quoted_post %}
        <div class="unit quoted-unit" data-post-id="{{ post.quoted_post.post_id }}">
            <div class="post quoted-post">
                <div class="icon_background">
                    {% if post.quoted_post.author.icon %}
                        <img src="{{ post.quoted_post.author.icon.url }}" class="icon">
                    {% endif %}
                </div>

                <div class="post-content">
                    <div class="name">
                        <label>{{ post.quoted_post.author.display_name }}</label>
                        @{{ post.quoted_post.author.username }}
                        <span style="margin-left: auto; font-size: 0.9rem; color: #bdbdbd;">
                            {{ post.quoted_post.created_at|timesince }}前
                        </span>
                    </div>

                    <div class="post-body">
                        {{ post.quoted_post.content|linebreaksbr }}
                        {% if post.quoted_post.image %}
                            <div class="post-image">
                                <img src="{{ post.quoted_post.image.url }}" alt="quoted image">
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% elif post.repost and not post.quoted_post %}
        <div class="unit quoted-unit">
            <div class="post quoted-post">
                <div class="none"><p>このポストは削除されています。</p></div>
            </div>
        </div>
        {% endif %}
        
        <div class="post-footer">
            <div class="buttons">
                <button class="comment-btn" onclick="location.href='{% url 'posts:detail' post.post_id %}'" style="text-decoration: none;">
                    <span class="material-symbols-rounded" style="font-variation-settings:'FILL' 0; color:#fffffff; margin-left:.4rem; margin-top:.3rem; font-size: 1.5rem; cursor: pointer;">chat_bubble</span><span class="like-count">{{ post.comment_count }}</span>
                </button>
                <form method="POST" style="display:inline;">
                    {% csrf_token %}
                    {% if post.is_liked %}
                        <button type="button" class="liked like-btn" data-post-id="{{ post.post_id }}" onclick="event.stopPropagation();">
                            <span class="material-symbols-rounded">favorite</span><span class="like-count">{{ post.like_count }}</span>
                        </button>
                    {% else %}
                        <button type="button" class="unlike like-btn" data-post-id="{{ post.post_id }}">
                            <span class="material-symbols-rounded">favorite</span><span class="like-count">{{ post.like_count }}</span>
                        </button>
                    {% endif %}
                </form>
                <button class="quote-btn" data-post-id="{{ post.post_id }}" onclick="event.stopPropagation();">
                    <span class="material-symbols-rounded">repeat</span><span class="quote-count">{{ post.quote_count }}</span>
                </button>
            </div>
            <span>ポストID:{{ post.post_id }}</span>
        </div>
            {% if current_user.is_authenticated %}
            <div class="comment-form">
                <span class="material-symbols-rounded" style="font-variation-settings:'FILL' 0; color:#ffffff88; margin-left:.4rem; margin-top:.3rem;">chat_bubble</span>
                <textarea class="autoresize_new" data-post-id="{{ post.post_id }}" placeholder="コメントする…"></textarea>
                <button type="button" class="comment-btn" data-post-id="{{ post.post_id }}">送信</button>
            </div>
            {% endif %}

        <div class="comment-list" data-post-id="{{ post.post_id }}">
            {% for comment in post.comments.all %}
                <div class="comment">
                    <div class="icon_background">
                        {% if comment.user.icon %}
                        <img src="{{ comment.user.icon.url }}" class="icon">
                        {% endif %}
                    </div>
                    {% if current_user.is_authenticated %}
                    <div class="post-content">
                        <div class="name"><label>{{ comment.user.display_name }}</label> @{{ comment.user.username }}<span style="margin-left: auto; font-size: .8rem; color: #ccc;">{{ comment.created_at|timesince }}前</span></div>
                    {% endif %}
                        <p class="comment-text">{{ comment.text }}</p>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

    /* =========================================================
        1) 引用モーダル処理（元ポスト表示つき）
    ========================================================== */

    const modal = document.getElementById("quoteModal");
    const quoteText = document.getElementById("quoteText");
    const quotePostId = document.getElementById("quotePostId");
    const quotedOriginal = document.getElementById("quotedOriginal");

    document.querySelectorAll(".quote-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            event.stopPropagation();

            const postId = btn.dataset.postId;
            quotePostId.value = postId;
            quoteText.value = "";

            const unit = btn.closest(".unit");
            const originalPost = unit.querySelector(".post");
            
            if (originalPost) {
                // 1. originalPost のHTMLコンテンツを一旦コンテナにロード
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = originalPost.innerHTML;

                // 2. ★ 投稿者の名前行 (.name) の中の時間表示要素を検索して削除
                // 時間表示は通常、.name divの末尾にある <span> 要素
                const timeSpan = tempDiv.querySelector('.name span[style*="margin-left: auto;"]');
                if (timeSpan) {
                    timeSpan.remove();
                }

                // 3. 削除ボタンがあればそれも削除（引用元には不要なため）
                const deleteBtn = tempDiv.querySelector('.name .delete-btn');
                if (deleteBtn) {
                    deleteBtn.remove();
                }

                // 4. クリーンアップされたHTMLをモーダルにセット
                quotedOriginal.innerHTML = `
                    <div class="quoted-box">
                        ${tempDiv.innerHTML}
                    </div>
                `;
            } else {
                quotedOriginal.innerHTML = "<div class='quoted-box'>（引用元を取得できませんでした）</div>";
            }

            // CSS Transitionを適用するため、クラスを追加する
            modal.classList.add('is-visible');
        });
    });

    // モーダル閉じる
    document.getElementById("closeModal").addEventListener("click", () => {
        // ★ 修正: CSS Transitionを適用するため、クラスを削除する
        // modal.style.display = "none"; <-- 削除
        modal.classList.remove('is-visible');
    });

    // 引用送信
    document.getElementById("sendQuote").addEventListener("click", () => {
        const text = quoteText.value.trim();
        const quotedId = quotePostId.value;
        const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;

        fetch("/posts/quote/", {
            method: "POST",
            headers: {
                "X-CSRFToken": csrfToken,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                text: text,
                quoted_post_id: quotedId
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.ok) {
                // ★ 修正: CSS Transitionを適用するため、クラスを削除する
                // modal.style.display = "none"; <-- 削除
                modal.classList.remove('is-visible');
                location.reload();
            }
        });
    });

    /* =========================================================
        2) 自動リサイズ
    ========================================================== */

    document.querySelectorAll('.autoresize, .autoresize_new').forEach(textarea => {
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';

        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        });
    });

    /* =========================================================
        3) いいね
    ========================================================== */

    document.querySelectorAll(".like-btn").forEach(button => {
        button.addEventListener("click", function() {

            const postId = this.dataset.postId;
            const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;
            const btn = this;

            fetch("{% url 'posts:toggle_like' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": csrfToken,
                    "Content-Type": "application/x-www-form-urlencoded",
                },
                body: `post_id=${postId}`
            })
            .then(res => res.json())
            .then(data => {
                if (!data.error) {
                    btn.classList.toggle("liked", data.is_liked);
                    btn.classList.toggle("unlike", !data.is_liked);

                    const count = btn.querySelector(".like-count");
                    count.textContent = data.like_count;
                }
            });
        });
    });

    /* =========================================================
        4) コメント投稿
    ========================================================== */

    document.querySelectorAll(".comment-btn").forEach(button => {
        button.addEventListener("click", () => {
            const postId = button.dataset.postId;
            const textarea = document.querySelector(`.autoresize_new[data-post-id="${postId}"]`);
            const text = textarea.value.trim();
            const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;

            if (!text) return;

            const formData = new FormData();
            formData.append("text", text);

            fetch(`/add_comment/${postId}/`, {
                method: "POST",
                headers: { "X-CSRFToken": csrfToken },
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.error) return;

                const commentList = document.querySelector(`.comment-list[data-post-id="${postId}"]`);

                const newComment = document.createElement("div");
                newComment.classList.add("comment");
                newComment.innerHTML = `
                    <div class="icon_background">
                        ${data.icon_url ? `<img src="${data.icon_url}" class="icon">` : ""}
                    </div>
                    <div class="post-content">
                        <div class="name"><label>${data.display_name}</label> @${data.username}</div>
                        <p class="comment-text">${data.text}</p>
                    </div>
                `;

                commentList.prepend(newComment);
                textarea.value = "";
            });
        });
    });
    
    /* =========================================================
        5) 投稿削除
    ========================================================== */

    document.querySelectorAll(".delete-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            if (!confirm("このポストを削除しますか？")) return;

            const postId = btn.dataset.postId;
            const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;

            fetch(`/delete/${postId}/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": csrfToken,
                    "Content-Type": "application/json"
                }
            })
            .then(res => res.json())
            .then(data => {
                if (data.ok) {
                    // 削除対象の投稿を画面から消す
                    const unit = btn.closest(".unit");
                    if (unit) unit.remove();
                }
            });
        });
    });

    /* =========================================================
        6) ログアウト警告
    ========================================================== */

    document.querySelector(".logout-form").addEventListener("submit", function(event) {
        // ユーザーがキャンセルした場合、フォームの送信を中止する
        if (!confirm("本当にログアウトしますか？")) {
            event.preventDefault(); // フォームのデフォルトの送信動作をキャンセル
        }
    });
});
</script>



{% endblock %}
